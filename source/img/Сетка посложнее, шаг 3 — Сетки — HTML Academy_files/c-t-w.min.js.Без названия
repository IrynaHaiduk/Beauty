function MCTWidget(a){this.host=a.host,this.host_view=window.location.protocol+"//tracking.mango-office.ru",this.id=a.id,this.date=new Date,this.elem=a.elem,this.element={},this.urls={data:"/widget-data","set-view":"/set-view","set-unique-view":"/set-unique-view"};var b=this;this.initWidget=function(){Date.prototype.getDaysInMonth=function(){return new Date(this.getFullYear(),this.getMonth()+1,0).getDate()};var a=JSON.parse(b.elem.getAttribute("data-settings"));b.id=a.id;var c=b.host+b.urls.data+"?callback=Mango"+(Date.now()+(Math.floor(1e4*Math.random())+0));b.getJSON(c,a,"callback",function(a){var c="mangoCallbackWidgetOptions_"+b.id;if(a!=[]&&a.response){a=a.response;var d=window.location.href,e=document.referrer,f=b.getCookie(c),g={};if(f&&null!=f&&1==a["same-phone-month"]&&(g=JSON.parse(f)),b.isEmpty(g)){var h="mangoCallbackWidgetSession_"+b.id,i=b.getCookie(h);i&&(g=JSON.parse(i))}if(b.isEmpty(g)){if(j=b.getFindChannel(d,a.channels),b.isEmpty(j))var j=b.getFindChannel(e,a.channels)}else j=b.getChannel(g.id_ch,a.channels);if(b.isEmpty(j)&&(j=b.getDefaultChannel(a.channels)),!b.isEmpty(j)){if(g={w_id:b.id,id_ch:j.id,phone_view:j.phone,is_view:b.date},j&&j.phone&&""!=j.phone){b.buildWidget(j.phone,a.style,a["custom-appearance"]);var k="mangoCallbackWidgetUnique_"+b.id,l=b.getCookie(k);if(b.isEmpty(l)){b.saveView({date:b.date,phone:j.phone,channel:j.keyword,"channel-id":j.id,"form-url":e,url:d,"did-id":j["did-id"],"widget-id":b.id});var m=new Date;m.setHours(23,59,59,999),b.createCookie(k,!0,m,"/")}b.createCookie(h,JSON.stringify(g),!1,"/")}1==a["same-phone-month"]&&b.createCookie(c,JSON.stringify(g),parseInt(b.date.getDaysInMonth()),"/")}}})},this.isEmpty=function(a){var b=Object.prototype.hasOwnProperty;if(null==a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var c in a)if(b.call(a,c))return!1;return!0},this.getCookie=function(a){var b=document.cookie.match(new RegExp("(?:^|; )"+a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return b?decodeURIComponent(b[1]):null},this.createCookie=function(a,b,c,d,e){var f=a+"="+b+";";c&&(c instanceof Date?isNaN(c.getTime())&&(c=new Date):c=new Date((new Date).getTime()+1e3*parseInt(c)*60*60*24),f+="expires="+c.toGMTString()+";"),d&&(f+="path="+d+";"),e&&(f+="domain="+e+";"),document.cookie=f},this.getDefaultChannel=function(a){for(var b=0;b<a.length;b++)if(1==a[b].default)return a[b];return{}},this.getChannel=function(a,b){for(var c=0;c<b.length;c++)if(b[c].id==a)return b[c];return{}},this.getFindChannel=function(a,b){for(var c=[],d=0;d<b.length;d++)""!=b[d].keyword&&a.indexOf(b[d].keyword)>-1&&c.push(b[d]);return 0!=c.length&&(c.sort(function(a,b){if(a.keyword.length-b.keyword.length!=0)return b.keyword.length-a.keyword.length;var c=a.keyword,d=b.keyword;return c<d?-1:d<c?1:0}),c[0]?c[0]:{})},this.buildWidget=function(a,c,d){if(d)var e="<div style='font-family: "+c.font_family+" !important;font-size:"+c.font_size+" !important;color:"+c.font_color+" !important;"+(1==c.weight_bold?"font-weight:bold !important;":"")+"'>"+a+"</div>";else var e="<div>"+a+"</div>";b.elem.innerHTML=e},this.saveView=function(a){this.getJSON(this.host_view+this.urls["set-view"]+"?callback=Mango"+(Date.now()+(Math.floor(1e4*Math.random())+0)),{params:JSON.stringify(a)},"callback",function(a){})},this.saveUniqueView=function(a){this.getJSON(this.host+this.urls["set-unique-view"]+"?callback=Mango"+(Date.now()+(Math.floor(1e4*Math.random())+0)),{params:JSON.stringify(a)},"callback",function(a){})},this.getJSON=function(a,b,c,d){var e="",f=this.getQueryString(a)[c];for(var g in b)e+="&"+g+"="+encodeURIComponent(b[g]);a+=e,window[f]=function(a){window[f]=void 0;try{delete window[f]}catch(a){}h&&h.removeChild(i),d(a)};var h=document.getElementsByTagName("head")[0],i=document.createElement("script");return i.charset="UTF-8",i.src=a,h.appendChild(i),!0},this.getQueryString=function(a){a&&(a=a.split("?")[1]);for(var e,b={},c=a||location.search.substring(1),d=/([^&=]+)=([^&]*)/g;e=d.exec(c);)b[decodeURIComponent(e[1])]=decodeURIComponent(e[2]);return b}}